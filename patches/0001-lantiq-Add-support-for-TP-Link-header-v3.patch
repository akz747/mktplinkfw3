From ad6360707a4f222e89cb19b75a7d33aee8dc88f3 Mon Sep 17 00:00:00 2001
From: Mathias Kresin <openwrt@kresin.me>
Date: Thu, 13 Aug 2015 17:53:59 +0200
Subject: [PATCH] lantiq: Add support for TP-Link header v3

---
 target/linux/lantiq/patches-3.18/0101-mtd-split.patch | 8 +++++---
 target/linux/lantiq/patches-4.1/0101-mtd-split.patch  | 8 +++++---
 2 files changed, 10 insertions(+), 6 deletions(-)

diff --git a/target/linux/lantiq/patches-3.18/0101-mtd-split.patch b/target/linux/lantiq/patches-3.18/0101-mtd-split.patch
index 6753a21..961baeb 100644
--- a/target/linux/lantiq/patches-3.18/0101-mtd-split.patch
+++ b/target/linux/lantiq/patches-3.18/0101-mtd-split.patch
@@ -10,7 +10,7 @@
  obj-$(CONFIG_PCI) += ath_eep.o rt_eep.o pci-ath-fixup.o
 --- /dev/null
 +++ b/arch/mips/lantiq/xway/mtd_split.c
-@@ -0,0 +1,129 @@
+@@ -0,0 +1,131 @@
 +#include <linux/magic.h>
 +#include <linux/root_dev.h>
 +#include <linux/mtd/mtd.h>
@@ -105,7 +105,8 @@
 +static void split_tplink_kernel(struct mtd_info *master, const char *name,
 +				int offset, int size)
 +{
-+#define TPLINK_MAGIC   0x00000002
++#define TPLINK_HEADER_V2   0x00000002
++#define TPLINK_HEADER_V3   0x00000003
 +	unsigned long magic = 0;
 +	unsigned long part_size = 0;
 +	size_t len;
@@ -118,7 +119,8 @@
 +	if (ret || len != sizeof(magic))
 +		return;
 +
-+	if (le32_to_cpu(magic) != TPLINK_MAGIC)
++	if (le32_to_cpu(magic) != TPLINK_HEADER_V2 &&
++	    le32_to_cpu(magic) != TPLINK_HEADER_V3)
 +		return;
 +
 +	ret = mtd_read(master, offset + 0x78, 4, &len, (void *)&part_size);
diff --git a/target/linux/lantiq/patches-4.1/0101-mtd-split.patch b/target/linux/lantiq/patches-4.1/0101-mtd-split.patch
index acda5aa..efab2c8 100644
--- a/target/linux/lantiq/patches-4.1/0101-mtd-split.patch
+++ b/target/linux/lantiq/patches-4.1/0101-mtd-split.patch
@@ -10,7 +10,7 @@
  obj-$(CONFIG_PCI) += ath_eep.o rt_eep.o pci-ath-fixup.o
 --- /dev/null
 +++ b/arch/mips/lantiq/xway/mtd_split.c
-@@ -0,0 +1,129 @@
+@@ -0,0 +1,131 @@
 +#include <linux/magic.h>
 +#include <linux/root_dev.h>
 +#include <linux/mtd/mtd.h>
@@ -105,7 +105,8 @@
 +static void split_tplink_kernel(struct mtd_info *master, const char *name,
 +				int offset, int size)
 +{
-+#define TPLINK_MAGIC   0x00000002
++#define TPLINK_HEADER_V2   0x00000002
++#define TPLINK_HEADER_V3   0x00000003
 +	unsigned long magic = 0;
 +	unsigned long part_size = 0;
 +	size_t len;
@@ -118,7 +119,8 @@
 +	if (ret || len != sizeof(magic))
 +		return;
 +
-+	if (le32_to_cpu(magic) != TPLINK_MAGIC)
++	if (le32_to_cpu(magic) != TPLINK_HEADER_V2 &&
++	    le32_to_cpu(magic) != TPLINK_HEADER_V3)
 +		return;
 +
 +	ret = mtd_read(master, offset + 0x78, 4, &len, (void *)&part_size);
-- 
1.9.1

